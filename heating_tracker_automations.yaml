# Heating Cycle Tracking Automations
# Add this to your automations.yaml or create a new file: automations/heating_tracker.yaml

# =============================================================================
# HEATING CYCLE COUNTING AUTOMATIONS
# =============================================================================

# Count heating cycles when heating turns ON (off -> on transitions)
- alias: "Count Zone ONE Heating Cycle"
  description: "Increment counter and record start time when Zone ONE heating turns on"
  trigger:
    - platform: state
      entity_id: binary_sensor.zone_one_heating_active
      from: 'off'
      to: 'on'
  action:
    - service: counter.increment
      target:
        entity_id: counter.zone_one_heating_cycles_today
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.zone_one_heating_start
      data:
        datetime: "{{ now() }}"
    - service: logbook.log
      data:
        name: "Heating Tracker"
        message: "Zone ONE heating cycle {{ states('counter.zone_one_heating_cycles_today') }} started"
        entity_id: binary_sensor.zone_one_heating_active

# =============================================================================
# HEATING DURATION TRACKING AUTOMATIONS
# =============================================================================

# Calculate heating duration when heating turns OFF (on -> off transitions)
- alias: "Calculate Zone ONE Heating Duration"
  description: "Calculate and add heating duration when Zone ONE heating turns off"
  trigger:
    - platform: state
      entity_id: binary_sensor.zone_one_heating_active
      from: 'on'
      to: 'off'
  action:
    - variables:
        start_time: "{{ states('input_datetime.zone_one_heating_start') }}"
        end_time: "{{ now() }}"
        duration_minutes: >
          {% set start = as_timestamp(start_time) %}
          {% set end = as_timestamp(end_time) %}
          {{ ((end - start) / 60) | round(1) }}
    - service: input_number.set_value
      target:
        entity_id: input_number.zone_one_total_heating_time_today
      data:
        value: >
          {{ 
            (states('input_number.zone_one_total_heating_time_today') | float) + 
            (duration_minutes | float) 
          }}
    - service: logbook.log
      data:
        name: "Heating Tracker"
        message: "Zone ONE heated for {{ duration_minutes }} minutes (Total today: {{ states('input_number.zone_one_total_heating_time_today') }} min)"

# =============================================================================
# DAILY RESET AUTOMATIONS
# =============================================================================

# Reset all counters and totals at midnight
- alias: "Reset Daily Heating Counters"
  description: "Reset all heating counters and totals at midnight"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    # Reset cycle counters
    - service: counter.reset
      target:
        entity_id:
          - counter.zone_one_heating_cycles_today
    # Reset total heating time accumulators
    - service: input_number.set_value
      target:
        entity_id: input_number.zone_one_total_heating_time_today
      data:
        value: 0
    - service: logbook.log
      data:
        name: "Heating Tracker"
        message: "Daily heating counters reset for new day"

# =============================================================================
# DAILY SUMMARY AUTOMATIONS
# =============================================================================

# Send daily heating summary report
- alias: "Daily Heating Summary Report"
  description: "Send daily heating statistics at 11 PM"
  trigger:
    - platform: time
      at: "23:00:00"
  condition:
    # Only send if there was any heating activity today
    - condition: numeric_state
      entity_id: counter.zone_one_heating_cycles_today
      above: 0
  action:
    - service: notify.mobile_app_your_phone  # Replace with your notification service
      data:
        title: "ðŸ“Š Daily Heating Report"
        message: >
          Today's heating summary for Zone ONE:
          
          ðŸ”¥ Total cycles: {{ states('counter.zone_one_heating_cycles_today') }}
          â±ï¸ Total time: {{ states('input_number.zone_one_total_heating_time_today') }} minutes
          ðŸ“Š Average duration: {{ states('sensor.zone_one_average_heating_duration') }} min
          âš¡ Efficiency: {{ states('sensor.daily_heating_efficiency_zone_one') }}%

# Weekly heating efficiency report (Sundays)
- alias: "Weekly Heating Efficiency Report"
  description: "Send weekly heating efficiency analysis"
  trigger:
    - platform: time
      at: "09:00:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: notify.mobile_app_your_phone
      data:
        title: "ðŸ“ˆ Weekly Heating Analysis"
        message: >
          This week's heating patterns for Zone ONE:
          
          {% set zone_avg = states('sensor.zone_one_average_heating_duration') | float %}
          {% if zone_avg < 10 %}
          âš ï¸ Short cycles - check insulation or thermostat location
          {% elif zone_avg > 30 %}
          ðŸ’¡ Long cycles - very efficient heating!
          {% else %}
          âœ… Normal heating cycles
          {% endif %}
          
          Monitor your heating patterns for optimal efficiency!

# =============================================================================
# HEATING ALERT AUTOMATIONS
# =============================================================================

# Alert for unusual heating patterns
- alias: "Unusual Heating Pattern Alert"
  description: "Alert when heating cycles are unusually frequent"
  trigger:
    - platform: numeric_state
      entity_id: counter.zone_one_heating_cycles_today
      above: 50  # Adjust threshold as needed
  action:
    - service: notify.mobile_app_your_phone
      data:
        title: "âš ï¸ High Heating Activity"
        message: >
          Unusual heating activity detected: {{ states('counter.zone_one_heating_cycles_today') }} cycles today in Zone ONE.
          This might indicate:
          â€¢ Temperature set too high/low
          â€¢ Poor insulation
          â€¢ System issues
          Check your heating settings and insulation.
        data:
          priority: high

# Alert for very short heating cycles (possible issues)
- alias: "Short Heating Cycle Alert"
  description: "Alert when average heating cycles are very short"
  trigger:
    - platform: numeric_state
      entity_id: sensor.zone_one_average_heating_duration
      below: 3  # Less than 3 minutes average
      for: "00:30:00"  # For 30 minutes
  action:
    - service: notify.mobile_app_your_phone
      data:
        title: "ðŸ”§ Heating System Check"
        message: >
          Zone ONE heating cycles are very short ({{ states('sensor.zone_one_average_heating_duration') }} min average).
          This might indicate a system issue or poor temperature sensor placement.
        data:
          priority: high
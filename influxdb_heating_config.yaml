# Heating Analytics Extension Package
# This package adds heating analytics sensors and tracking
# Note: InfluxDB integration must be configured in main configuration.yaml

# =============================================================================
# INFLUXDB ENTITY CONFIGURATION - Add these entities to your existing InfluxDB config
# =============================================================================
# Add these entities to your existing influxdb: include: entities: section in configuration.yaml:
#
# influxdb:
#   include:
#     entities:
#       # Core heating metrics
#       - binary_sensor.zone_one_heating_active
#       - counter.zone_one_heating_cycles_today  
#       - sensor.zone_one_average_heating_duration
#       - input_number.zone_one_total_heating_time_today
#       - sensor.daily_heating_efficiency_zone_one
#       - climate.one
#       - sensor.zone_one_heating_time_today
#       - sensor.zone_one_heating_cycles_count_today
#       - input_datetime.zone_one_heating_start

# =============================================================================
# STATISTICS SENSORS - For long-term analytics
# =============================================================================
sensor:
  # Monthly heating statistics
  - platform: statistics
    name: "Monthly Heating Cycles Average"
    entity_id: counter.zone_one_heating_cycles_today
    state_characteristic: mean
    max_age:
      days: 30
    sampling_size: 30

  - platform: statistics
    name: "Monthly Average Heating Duration"  
    entity_id: sensor.zone_one_average_heating_duration
    state_characteristic: mean
    max_age:
      days: 30
    sampling_size: 30

  # Weekly efficiency tracking
  - platform: statistics
    name: "Weekly Heating Efficiency"
    entity_id: sensor.daily_heating_efficiency_zone_one
    state_characteristic: mean
    max_age:
      days: 7
    sampling_size: 7

  # Total monthly heating time
  - platform: statistics
    name: "Monthly Total Heating Time"
    entity_id: input_number.zone_one_total_heating_time_today
    state_characteristic: total
    max_age:
      days: 30
    sampling_size: 30

# =============================================================================
# UTILITY METER - Track heating costs by period
# =============================================================================
utility_meter:
  # Daily heating time meter
  daily_heating_time:
    source: input_number.zone_one_total_heating_time_today
    cycle: daily
    
  # Monthly heating cycles meter  
  monthly_heating_cycles:
    source: counter.zone_one_heating_cycles_today
    cycle: monthly
    
  # Weekly heating efficiency meter
  weekly_heating_efficiency:
    source: sensor.daily_heating_efficiency_zone_one
    cycle: weekly

# =============================================================================
# TEMPLATE SENSORS - Cost calculations with InfluxDB data
# =============================================================================
template:
  - sensor:
      # Daily heating cost based on actual time
      - name: "Daily Heating Cost"
        unit_of_measurement: "£"
        state: >
          {% set hours = states('input_number.zone_one_total_heating_time_today') | float(0) / 60 %}
          {% set kwh_per_hour = 3.0 %}
          {% set cost_per_kwh = 0.28 %}
          {{ (hours * kwh_per_hour * cost_per_kwh) | round(2) }}
        icon: mdi:currency-gbp
        
      # Monthly cost projection
      - name: "Monthly Heating Cost Projection"
        unit_of_measurement: "£"
        state: >
          {% set daily_cost = states('sensor.daily_heating_cost') | float(0) %}
          {% set days_in_month = now().replace(day=1) + timedelta(days=32) %}
          {% set days_in_month = days_in_month.replace(day=1) - timedelta(days=1) %}
          {{ (daily_cost * days_in_month.day) | round(0) }}
        icon: mdi:calendar-month
        
      # Heating efficiency trend (7-day average)
      - name: "Heating Efficiency Trend" 
        unit_of_measurement: "%"
        state: >
          {{ states('sensor.weekly_heating_efficiency') | float(0) | round(1) }}
        icon: mdi:trending-up